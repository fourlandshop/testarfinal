<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Camera</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsfeat/0.0.8/jsfeat.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: black;
        }
        
        video {
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }
        
        #targetVideo {
            position: absolute;
            pointer-events: none;
            display: none;
            z-index: 10;
        }
        
        #debugInfo {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 12px;
            background: rgba(0,0,0,0.7);
            padding: 5px;
            border-radius: 3px;
            z-index: 20;
        }
    </style>
</head>
<body>
    <video id="camera" autoplay playsinline></video>
    <video id="targetVideo" src="./video.mp4" loop muted playsinline></video>
    <div id="debugInfo">جستجوی مارکر...</div>
    
    <script>
        const video = document.getElementById('camera');
        const targetVideo = document.getElementById('targetVideo');
        const debugInfo = document.getElementById('debugInfo');
        
        let canvas, ctx;
        let targetImage = new Image();
        let isProcessing = false;
        let frameCount = 0;
        
        // بارگذاری عکس مارکر
        targetImage.crossOrigin = "anonymous";
        targetImage.src = './marker.jpg';
        
        targetImage.onload = () => {
            console.log('Marker loaded');
            debugInfo.textContent = 'مارکر بارگذاری شد';
        };
        
        targetImage.onerror = () => {
            debugInfo.textContent = 'خطا در بارگذاری مارکر';
        };
        
        // شروع دوربین
        navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: 'environment',
                width: { ideal: 640 },  // کیفیت کمتر برای سرعت بیشتر
                height: { ideal: 480 }
            }
        })
        .then(stream => {
            video.srcObject = stream;
            
            video.addEventListener('loadedmetadata', () => {
                // ایجاد canvas مخفی برای پردازش
                canvas = document.createElement('canvas');
                canvas.width = 320; // سایز کوچک برای پردازش سریع
                canvas.height = 240;
                ctx = canvas.getContext('2d');
                
                // شروع پردازش
                processFrame();
            });
        })
        .catch(err => {
            debugInfo.textContent = 'خطا در دوربین: ' + err.message;
        });
        
        function processFrame() {
            if (video.readyState === video.HAVE_ENOUGH_DATA && !isProcessing) {
                frameCount++;
                
                // فقط هر 5 فریم یکبار پردازش کن (برای سرعت)
                if (frameCount % 5 === 0) {
                    detectMarker();
                }
            }
            
            requestAnimationFrame(processFrame);
        }
        
        function detectMarker() {
            if (!targetImage.complete) return;
            
            isProcessing = true;
            
            // رسم فریم کوچک برای پردازش
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // جستجوی ساده با تطبیق رنگ
            const match = findColorMatch();
            
            if (match) {
                debugInfo.textContent = `مارکر پیدا شد! اعتماد: ${match.confidence.toFixed(2)}`;
                showVideoAtPosition(match.x, match.y, match.size);
            } else {
                debugInfo.textContent = 'در جستجوی مارکر...';
                hideVideo();
            }
            
            isProcessing = false;
        }
        
        function findColorMatch() {
            // تحلیل رنگ‌های غالب عکس مارکر (ساده‌سازی)
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let bestMatch = null;
            let maxScore = 0;
            
            // جستجو در بلوک‌های 40x40 پیکسلی
            const blockSize = 40;
            
            for (let y = 0; y < canvas.height - blockSize; y += 20) {
                for (let x = 0; x < canvas.width - blockSize; x += 20) {
                    const score = analyzeBlock(data, x, y, blockSize, canvas.width);
                    
                    if (score > maxScore && score > 0.3) {
                        maxScore = score;
                        bestMatch = {
                            x: (x + blockSize/2) * (window.innerWidth / canvas.width),
                            y: (y + blockSize/2) * (window.innerHeight / canvas.height),
                            size: blockSize * 4,
                            confidence: score
                        };
                    }
                }
            }
            
            return bestMatch;
        }
        
        function analyzeBlock(data, startX, startY, blockSize, canvasWidth) {
            let r = 0, g = 0, b = 0, pixels = 0;
            let variance = 0;
            
            // محاسبه میانگین رنگ در بلوک
            for (let y = startY; y < startY + blockSize; y++) {
                for (let x = startX; x < startX + blockSize; x++) {
                    const i = (y * canvasWidth + x) * 4;
                    r += data[i];
                    g += data[i + 1];
                    b += data[i + 2];
                    pixels++;
                }
            }
            
            if (pixels === 0) return 0;
            
            r /= pixels;
            g /= pixels;
            b /= pixels;
            
            // محاسبه واریانس (برای تشخیص نواحی با جزئیات)
            for (let y = startY; y < startY + blockSize; y++) {
                for (let x = startX; x < startX + blockSize; x++) {
                    const i = (y * canvasWidth + x) * 4;
                    const gray = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    const avgGray = (r + g + b) / 3;
                    variance += Math.pow(gray - avgGray, 2);
                }
            }
            
            variance /= pixels;
            
            // امتیازدهی: واریانس بالا + کنتراست مناسب = احتمال وجود مارکر
            const contrastScore = Math.min(variance / 1000, 1);
            const brightnessScore = 1 - Math.abs((r + g + b) / 3 - 128) / 128;
            
            return (contrastScore * 0.7 + brightnessScore * 0.3);
        }
        
        function showVideoAtPosition(x, y, size) {
            targetVideo.style.display = 'block';
            targetVideo.style.left = (x - size/2) + 'px';
            targetVideo.style.top = (y - size/2) + 'px';
            targetVideo.style.width = size + 'px';
            targetVideo.style.height = (size * 0.75) + 'px';
            
            if (targetVideo.paused) {
                targetVideo.play().catch(e => {
                    console.log('Video autoplay blocked');
                });
            }
        }
        
        function hideVideo() {
            targetVideo.style.display = 'none';
            if (!targetVideo.paused) {
                targetVideo.pause();
            }
        }
        
        // کلیک برای شروع پخش (در صورت block شدن autoplay)
        document.addEventListener('click', () => {
            if (targetVideo.style.display === 'block' && targetVideo.paused) {
                targetVideo.play();
            }
        }, { once: true });
        
    </script>
</body>
</html>
